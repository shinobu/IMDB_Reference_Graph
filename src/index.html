<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>IMDB Graph Relation Visualization</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">

    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js" ></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="js/neo4jQueryProxy.js"></script>
</head>

<body>
    <div id="header">
        <h4>IMDB Graph Relation Visualization</h4>
    </div>
        <div id="graph">

        </div>
        <div id="userInput">
            <div class="ui-widget" style=" margin-left: 1em; margin-right: 1em; margin-top: 10px; color:white; text-align: center;">
                <div id="form" name="MovieAdder" style="display: inline-block; text-align: left; ">
                    <p><label for="movies">Movie Search:</label></p>
                    <p style="margin-bottom: 2.5em">
                        <input id="movies" style="color:black;">
                        <button type="movieAdder" onclick="addMovie()" style="color:black;">Add Movie</button>
                    </p>
                    <p>Relations:</p>
                    <p><input type="checkbox" id="alternateLanguageVersionOf" value="alternate language version of"
                              checked>alternate language version of</p>
                    <p><input type="checkbox" id="editedInto" value="edited into" checked>edited into</p>
                    <p><input type="checkbox" id="features" value="features" checked>features</p>
                    <p><input type="checkbox" id="follows" value="follows" checked>follows</p>
                    <p><input type="checkbox" id="references" value="references" checked>references</p>
                    <p><input type="checkbox" id="remakeOf" value="remake of" checked>remake of</p>
                    <p><input type="checkbox" id="spinOff" value="spin off" checked>spin off</p>
                    <p><input type="checkbox" id="spoofs" value="spoofs" checked>spoofs</p>
                    <p style="margin-bottom: 1em;"><input type="checkbox" id="versionOf" value="version of" checked>version of</p>
                    <button type="refresh" onsubmit="refreshGraph()" style="color:black;">Refresh Graph</button>
                </div>
                <div class="ui-widget" style="margin-top:2em; display: inline-block; text-align: left; width: 100%">
                    <p>Chosen Movies:</p>
                    <div id="movieList" style="margin-top:1em; display: inline-block; text-align: left;"></div>
                </div>
            </div>
        </div>
    <div id="node">

    </div>
<script>
var neo4jAutEnc = btoa("neo4j:neo4j1"),
    neo4jServer = "/api", // http://localhost:7474/
    chosenMovies = [],
    nodes,
    links,
    notRefreshing = true;

$(function () {
    $("#movies").autocomplete({
        source: function( request, response ) {
            window.neo4jQuery({"statements":[{"statement": "MATCH (n:Movie) WHERE n.title STARTS WITH \"" + request.term + "\" RETURN n.title + \" \" + n.date"}]}, autoSearchDataTransformation, neo4jServer, neo4jAutEnc, response);
        },
        minLength: 3,
    });
});

function autoSearchDataTransformation(data, response) {
    var dataArray = [];
    console.log(data);
    if(data.results.length > 0) {
        for (var i = 0, len = data.results[0].data.length; i < len; i++) {
            dataArray.push({ "label":data.results[0].data[i].row[0], "value":data.results[0].data[i].row[0]});
        }
    }
    response(dataArray);
}

function addMovie() {
    if (document.getElementById("movies").value == "") {
        alert("Textbox is empty");
        return;
    }
    var tmp = document.getElementById("movies").value, split;
    document.getElementById("movies").value = "";
    split = tmp.lastIndexOf(" (");
    if (split != -1) {
        window.neo4jQuery({"statements":[{"statement": "MATCH (n:Movie) WHERE n.title = \"" + tmp.substring(0, split) + "\" AND n.date = \"" + tmp.substring(split + 1, tmp.length) + "\" RETURN n.title + \" \" + n.date"}]}, addMovieResponse, neo4jServer, neo4jAutEnc, undefined);
    } else {
        alert("No Existing Movie");
    }
}

function addMovieResponse(data) {
    if(data.results.length < 1) {
        alert("No Existing Movie");
        return;
    }
    if (chosenMovies.indexOf(data.results[0].data[0].row[0]) == -1) {
       chosenMovies.push(data.results[0].data[0].row[0]);
    }
    //loadChosenMovies();
    console.log(chosenMovies);
}

function refreshGraph() {
    var chosenValues = getData(), tmpQuery;
    if (chosenMovies.length < 1 && chosenValues[2].length < 1) {
        alert("No Movies Chosen");
        return;
    }
    tmpQuery = "Match (n:Movie)-[r:Relation]-(m:Movie) Where (";
    for (var i = 0, length = chosenValues[0].length; i<length;i++) {
        tmpQuery += ("(n.title = \"" + chosenValues[0][i] + "\" AND n.date = \"" + chosenValues[1][i] + "\")")
        if(i != (chosenValues[0].length - 1)) {
            tmpQuery += " OR ";
        }
    }
    tmpQuery += ") AND r.type in " + JSON.stringify(chosenValues[2]) + " Return n,m,r";
    window.neo4jQuery({"statements":[{"statement": tmpQuery}]}, refreshGraphResponse, neo4jServer, neo4jAutEnc, undefined)
}

function getData() {
    var dataArray = [], tmpArrayMovies = [], tmpArrayDates = [], tmpArrayRefs = [];
    for (var i = 0, length = chosenMovies.length; i < length; i++) {
        split = chosenMovies[i].lastIndexOf(" (");
        tmpArrayMovies.push(chosenMovies[i].substring(0, split));
        tmpArrayDates.push(chosenMovies[i].substring(split + 1, chosenMovies[i].length));
    }
    dataArray.push(tmpArrayMovies);
    dataArray.push(tmpArrayDates);
    if (document.getElementById("alternateLanguageVersionOf").checked == true) {
        tmpArrayRefs.push(document.getElementById("alternateLanguageVersionOf").value);
    }
    if (document.getElementById("editedInto").checked == true) {
        tmpArrayRefs.push(document.getElementById("editedInto").value);
    }
    if (document.getElementById("features").checked == true) {
        tmpArrayRefs.push(document.getElementById("features").value);
    }
    if (document.getElementById("follows").checked == true) {
        tmpArrayRefs.push(document.getElementById("follows").value);
    }
    if (document.getElementById("references").checked == true) {
        tmpArrayRefs.push(document.getElementById("references").value);
    }
    if (document.getElementById("remakeOf").checked == true) {
        tmpArrayRefs.push(document.getElementById("remakeOf").value);
    }
    if (document.getElementById("spinOff").checked == true) {
        tmpArrayRefs.push(document.getElementById("spinOff").value);
    }
    if (document.getElementById("spoofs").checked == true) {
        tmpArrayRefs.push(document.getElementById("spoofs").value);
    }
    if (document.getElementById("versionOf").checked == true) {
        tmpArrayRefs.push(document.getElementById("versionOf").value);
    }
    dataArray.push(tmpArrayRefs);
    return dataArray;
}

function refreshGraphResponse(data) {

}



//match (n:Movie) where n.title starts with "'Allo 'Allo!" return n.title + " " + n.date

//window.neo4jQuery({"statements":[{"statement": "match (n:Movie) return n"}]}, test, neo4jServer, neo4jAutEnc);

//function test (data) {
//    var test = data.results[0].data;
//    console.log(test[0].row[1]);
//}
</script>
</body>
</html>
